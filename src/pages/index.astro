---
import SlotCentered from "@/components/SlotCentered.astro";
import Layout from "@/layouts/Layout.astro";
import LottieAnimation from "astro-integration-lottie/Lottie.astro";
---

<script>
  import { actions, isInputError } from "astro:actions";

  const form = document.querySelector("form");

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const input1ErrorField = document.querySelector("#your-name-error") as HTMLDivElement;
    const input2ErrorField = document.querySelector("#so-name-error") as HTMLDivElement;
    const response = document.querySelector("#response") as HTMLDivElement;

    // Reset Error Fields
    input1ErrorField.textContent = "";
    input2ErrorField.textContent = "";

    const { data, error } = await actions.formHandler({
      "your-name": formData.get("your-name") as string,
      "so-name": formData.get("so-name") as string,
    });

    // Error Handler
    if (error && isInputError(error)) {
      if (error.fields["your-name"]) {
        input1ErrorField.textContent = error.fields["your-name"].join(", ") ?? "";
      }

      if (error.fields["so-name"]) {
        input2ErrorField.textContent = error.fields["so-name"].join(", ") ?? "";
      }

      return;
    }

    if (!error) {
      const formTarget = e.target as HTMLFormElement;
      formTarget.reset();

      const successMessage = "Congratulations, this is your url: ";
      response.innerHTML =
        successMessage +
        `<a class="underline font-bold" href=${`/letters/${data.url}`}>/${data.url}</a>`;
    }
  });
</script>

<Layout title="Hello Valentine">
  <SlotCentered>
    <!-- Header  -->
    <div class="flex flex-row gap-4 items-center px-8 md:px-0">
      <LottieAnimation class="w-8 h-8 mx-auto" src="assets/lotties/heart.json" autoplay="visible" />
      <h1 class="font-secondary text-3xl text-primary-accent text-center">
        Welcome to Project Valentine
      </h1>
      <LottieAnimation class="w-8 h-8 mx-auto" src="assets/lotties/heart.json" autoplay="visible" />
    </div>
    <!-- Content -->
    <div class="spring">
      <p class="font-secondary text-lg text-primary-accent text-center">
        A website to show your love for your significant other
      </p>

      <!-- Form Submission -->
      <form method="post" class="grid grid-cols-2 items-center gap-1 mt-4">
        <!-- Input 1 -->
        <label for="your-name" class="font-secondary text-primary-accent text-base text-center">
          Enter Name 1
        </label>
        <input
          type="text"
          placeholder="Your Name"
          name="your-name"
          class="py-1 px-2 rounded mx-auto my-2 font-secondary text-tertiary-accent"
        />
        <div id="your-name-error" class="col-span-2 text-center font-tertiary text-tertiary-accent">
        </div>
        <!-- Input 2 -->
        <label for="so-name" class="font-secondary text-primary-accent text-base text-center">
          Enter Name 2
        </label>
        <input
          type="text"
          placeholder="Significant Other's Name"
          name="so-name"
          class="py-1 px-2 rounded mx-auto my-2 font-secondary text-tertiary-accent"
        />
        <div
          id="so-name-error"
          class="col-span-2 text-center font-tertiary text-tertiary-accent mb-4"
        >
        </div>
        <!-- Submit Button -->
        <button
          type="submit"
          class="py-1 px-2 col-span-2 rounded mx-auto bg-secondary-accent hover:bg-secondary text-white hover:text-secondary-accent font-secondary transition-colors duration-300"
          >Submit
        </button>
      </form>

      <!-- Response Form Submission -->
      <div id="response" class="my-4 text-center text-secondary-accent font-secondary"></div>
    </div>
  </SlotCentered>
</Layout>
